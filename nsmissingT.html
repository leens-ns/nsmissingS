<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>남성초등학교 분실물 센터 (교사용)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
      color: #111827;
      padding: 16px;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
    }
    header {
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    header p {
      font-size: 0.9rem;
      color: #6b7280;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #eef2ff;
      color: #4338ca;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-danger {
      background: #ef4444;
      color: #ffffff;
    }
    .btn-outline {
      background: transparent;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1.4fr;
      gap: 16px;
    }
    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
    }
    .card h2 {
      font-size: 1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .notice {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    form label {
      font-size: 0.8rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      color: #374151;
    }
    form input[type="text"],
    form select,
    form input[type="datetime-local"],
    form input[type="file"],
    textarea {
      width: 100%;
      font-size: 0.85rem;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-bottom: 8px;
    }
    textarea {
      resize: vertical;
      min-height: 48px;
    }
    .form-row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .status-label {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-stored {
      background: #dcfce7;
      color: #166534;
    }
    .status-found {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .status-discarded {
      background: #fee2e2;
      color: #b91c1c;
    }
    #itemsContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .item-card {
      display: flex;
      gap: 10px;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
      transition: box-shadow 0.15s ease, transform 0.1s ease;
    }
    .item-card:hover {
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }
    .item-thumb {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      background: #e5e7eb;
    }
    .item-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .item-body {
      flex: 1;
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .item-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }
    .item-title {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .item-meta {
      color: #4b5563;
      line-height: 1.4;
    }
    .item-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #9ca3af;
      align-items: center;
    }
    .item-actions {
      display: flex;
      gap: 6px;
    }
    .empty-message {
      text-align: center;
      padding: 12px;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    /* 상세 모달 */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(15, 23, 42, 0.35);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    .modal-header h3 {
      font-size: 1rem;
    }
    .modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 4px;
      color: #6b7280;
    }
    .modal-image {
      width: 100%;
      border-radius: 10px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .modal-image img {
      width: 100%;
      height: auto;
      display: block;
    }
    .modal-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 6px;
    }
    .modal-field {
      margin-bottom: 6px;
    }
    .modal-field label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .modal-field input,
    .modal-field textarea {
      width: 100%;
      font-size: 0.85rem;
      padding: 6px 7px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .modal-field textarea {
      min-height: 48px;
      resize: vertical;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }
    .modal-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>남성초등학교 분실물 센터 (교사용)</h1>
      <p>Firestore + imgbb 로 모든 기기에서 같은 분실물 목록을 관리합니다.</p>
    </header>

    <div class="top-bar">
      <div class="chip">
        <span>로그인 상태:</span>
        <span id="userInfo">로그인하지 않음</span>
      </div>
      <div>
        <button id="loginBtn" class="btn btn-primary">Google 로그인</button>
        <button id="logoutBtn" class="btn btn-secondary" style="display:none;">
          로그아웃
        </button>
      </div>
    </div>

    <div class="layout">
      <!-- 등록 폼 -->
      <div class="card" id="teacherFormWrapper" style="display:none;">
        <h2>새 분실물 등록</h2>
        <p class="notice">
          ※ @nsworld.net 교사 계정으로 로그인한 경우에만 등록할 수 있습니다.
          <br />
          ※ 이미지는 업로드 시 800px 로 자동 리사이즈 후 imgbb에 저장됩니다.
        </p>

        <form id="lostItemForm">
          <label for="itemImage">분실물 사진 (필수)</label>
          <input type="file" id="itemImage" accept="image/*" />

          <label for="itemTitle">분실물 이름 / 설명 (필수)</label>
          <input
            type="text"
            id="itemTitle"
            placeholder="예: 파란색 물통, 4-1 반 이름표"
          />

          <div class="form-row-2">
            <div>
              <label for="itemCategory">카테고리</label>
              <select id="itemCategory">
                <option value="학용품">학용품</option>
                <option value="의류">의류</option>
                <option value="전자기기">전자기기</option>
                <option value="책/노트">책/노트</option>
                <option value="기타" selected>기타</option>
              </select>
            </div>
            <div>
              <label for="storageLocation">보관 장소</label>
              <select id="storageLocation">
                <option value="교무실">교무실</option>
                <option value="각 층 복도">각 층 복도</option>
                <option value="체육관">체육관</option>
                <option value="기타">기타</option>
              </select>
            </div>
          </div>

          <label for="foundPlace">습득 장소 (필수)</label>
          <input
            type="text"
            id="foundPlace"
            placeholder="예: 운동장, 4-1 교실, 강당"
          />

          <div class="form-row-2">
            <div>
              <label for="foundTime">습득 시간 (선택)</label>
              <input type="datetime-local" id="foundTime" />
            </div>
            <div>
              <label for="finderName">습득자 성명 (선택)</label>
              <input
                type="text"
                id="finderName"
                placeholder="예: 4-1 홍길동 / 3학년 교사"
              />
            </div>
          </div>

          <div style="margin-top:10px; text-align:right;">
            <button type="reset" class="btn btn-secondary">초기화</button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              등록
            </button>
          </div>
        </form>
      </div>

      <!-- 분실물 목록 -->
      <div class="card">
        <h2>
          분실물 목록
          <span style="font-size:0.8rem; font-weight:400; color:#6b7280;">
            (실시간 Firestore)
          </span>
        </h2>
        <p class="notice">
          ※ 카드를 누르면 상세 팝업이 뜹니다. 팝업에서 내용 수정, 재등록이
          가능합니다.
        </p>
        <div id="itemsContainer"></div>
        <div
          id="emptyMessage"
          class="empty-message"
          style="display:none;"
        >
          아직 등록된 분실물이 없습니다.
        </div>
      </div>
    </div>
  </div>

  <!-- 상세 모달 -->
  <div class="modal-backdrop" id="detailModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitleText">분실물 상세 정보</h3>
        <button class="modal-close" id="modalCloseBtn" aria-label="닫기">
          ✕
        </button>
      </div>

      <div class="modal-image">
        <img id="modalImage" alt="분실물 이미지" />
      </div>

      <div class="modal-field">
        <label>상태</label>
        <div id="modalStatusLabel"></div>
        <div class="modal-hint">
          * 상태는 카드의 “주인 찾음 처리 / 삭제” 버튼으로도 변경할 수
          있습니다.
        </div>
      </div>

      <div class="modal-field">
        <label for="modalTitleInput">분실물 이름 / 설명</label>
        <input id="modalTitleInput" type="text" />
      </div>

      <div class="modal-grid">
        <div class="modal-field">
          <label for="modalCategoryInput">카테고리</label>
          <input id="modalCategoryInput" type="text" />
        </div>
        <div class="modal-field">
          <label for="modalStorageInput">보관 장소</label>
          <input id="modalStorageInput" type="text" />
        </div>
      </div>

      <div class="modal-grid">
        <div class="modal-field">
          <label for="modalFoundPlaceInput">습득 장소</label>
          <input id="modalFoundPlaceInput" type="text" />
        </div>
        <div class="modal-field">
          <label for="modalFoundTimeInput">습득 시간</label>
          <input id="modalFoundTimeInput" type="text" />
        </div>
      </div>

      <div class="modal-grid">
        <div class="modal-field">
          <label for="modalFinderInput">습득자</label>
          <input id="modalFinderInput" type="text" />
        </div>
        <div class="modal-field">
          <label for="modalCreatedAtInput">등록일</label>
          <input id="modalCreatedAtInput" type="text" disabled />
        </div>
      </div>

      <div class="modal-field">
        <label for="modalOwnerInfoInput">주인 정보 / 메모</label>
        <textarea
          id="modalOwnerInfoInput"
          placeholder="예: 4-1 홍길동, 2025-09-01 찾아감 등"
        ></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline" id="modalEditBtn">
          수정하기
        </button>
        <button class="btn btn-secondary" id="modalReRegisterBtn">
          재등록
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase 초기화 (지금 사용 중인 설정으로 교체해 주세요) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDyp8MRjZUwZZxBMUZBDpCqYac2TaMIO5M",
      authDomain: "nsmissingt-e9fbf.firebaseapp.com",
      projectId: "nsmissingt-e9fbf",
      storageBucket: "nsmissingt-e9fbf.firebasestorage.app",
      messagingSenderId: "163980342864",
      appId: "1:163980342864:web:e699b4d11af04752cd0355"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== imgbb API 키 (이미 쓰고 있던 값 그대로) =====
    const IMGBB_API_KEY = "b6eac487cb547bc827cef84b2fbbd7c7";

    // ===== DOM 참조 =====
    const userInfoEl = document.getElementById("userInfo");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const teacherFormWrapper = document.getElementById("teacherFormWrapper");

    const lostItemForm = document.getElementById("lostItemForm");
    const itemImageInput = document.getElementById("itemImage");
    const itemTitleInput = document.getElementById("itemTitle");
    const itemCategorySelect = document.getElementById("itemCategory");
    const storageLocationSelect = document.getElementById("storageLocation");
    const foundPlaceInput = document.getElementById("foundPlace");
    const foundTimeInput = document.getElementById("foundTime");
    const finderNameInput = document.getElementById("finderName");
    const submitBtn = document.getElementById("submitBtn");

    const itemsContainer = document.getElementById("itemsContainer");
    const emptyMessage = document.getElementById("emptyMessage");

    // 모달 DOM
    const detailModalBackdrop = document.getElementById(
      "detailModalBackdrop"
    );
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalImage = document.getElementById("modalImage");
    const modalStatusLabel = document.getElementById("modalStatusLabel");
    const modalTitleText = document.getElementById("modalTitleText");

    const modalTitleInput = document.getElementById("modalTitleInput");
    const modalCategoryInput = document.getElementById("modalCategoryInput");
    const modalStorageInput = document.getElementById("modalStorageInput");
    const modalFoundPlaceInput = document.getElementById(
      "modalFoundPlaceInput"
    );
    const modalFoundTimeInput = document.getElementById("modalFoundTimeInput");
    const modalFinderInput = document.getElementById("modalFinderInput");
    const modalCreatedAtInput = document.getElementById(
      "modalCreatedAtInput"
    );
    const modalOwnerInfoInput = document.getElementById(
      "modalOwnerInfoInput"
    );
    const modalEditBtn = document.getElementById("modalEditBtn");
    const modalReRegisterBtn = document.getElementById("modalReRegisterBtn");

    let currentUser = null;
    let isTeacher = false;
    let items = [];
    let unsubscribeItems = null;

    // 모달 상태
    let currentModalItemId = null;
    let modalEditMode = false;

    function statusLabel(item) {
      if (!item.status || item.status === "stored") return "보관 중";
      if (item.status === "found") return "주인 찾음";
      if (item.status === "discarded") return "폐기";
      return item.status;
    }

    function statusClass(item) {
      if (!item.status || item.status === "stored") return "status-stored";
      if (item.status === "found") return "status-found";
      if (item.status === "discarded") return "status-discarded";
      return "status-stored";
    }

    function formatDateTime(isoString) {
      if (!isoString) return "-";
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return "-";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}. ${m}. ${day}. ${hh}:${mm}`;
    }

    function updateAuthUI() {
      if (!currentUser) {
        userInfoEl.textContent = "로그인하지 않음";
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
        teacherFormWrapper.style.display = "none";
        isTeacher = false;
        return;
      }
      const email = currentUser.email || "";
      userInfoEl.textContent = `${currentUser.displayName || ""} (${email})`;

      // @nsworld.net 계정만 교사 권한
      isTeacher = email.endsWith("@nsworld.net");
      if (isTeacher) {
        teacherFormWrapper.style.display = "block";
      } else {
        teacherFormWrapper.style.display = "none";
      }
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-flex";

      if (!unsubscribeItems) {
        subscribeItems();
      }
    }

    function subscribeItems() {
      if (unsubscribeItems) unsubscribeItems();
      unsubscribeItems = db
        .collection("lost_items")
        .orderBy("createdAt", "desc")
        .onSnapshot(
          (snapshot) => {
            items = snapshot.docs.map((doc) => {
              const data = doc.data() || {};
              return {
                id: doc.id,
                title: data.title || "",
                category: data.category || "기타",
                storageLocation: data.storageLocation || "",
                foundPlace: data.foundPlace || "",
                foundTime: data.foundTime || "",
                finderName: data.finderName || "",
                createdAt: data.createdAt || "",
                imageUrl: data.imageUrl || "",
                status: data.status || "stored",
                ownerInfo: data.ownerInfo || ""
              };
            });
            renderItems();
          },
          (error) => {
            console.error("분실물 불러오기 오류:", error);
          }
        );
    }

    function renderItems() {
      itemsContainer.innerHTML = "";
      if (!items.length) {
        emptyMessage.style.display = "block";
        return;
      }
      emptyMessage.style.display = "none";

      items.forEach((item) => {
        const card = document.createElement("div");
        card.className = "item-card";
        card.dataset.id = item.id;

        const thumb = document.createElement("div");
        thumb.className = "item-thumb";
        const img = document.createElement("img");
        img.src = item.imageUrl || "";
        img.alt = item.title || "분실물 이미지";
        thumb.appendChild(img);

        const body = document.createElement("div");
        body.className = "item-body";

        const titleRow = document.createElement("div");
        titleRow.className = "item-title-row";

        const titleEl = document.createElement("div");
        titleEl.className = "item-title";
        titleEl.textContent = item.title || "분실물";

        const statusEl = document.createElement("span");
        statusEl.className =
          "status-label " + statusClass(item);
        statusEl.textContent = statusLabel(item);

        titleRow.appendChild(titleEl);
        titleRow.appendChild(statusEl);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        meta.innerHTML = `
          <div>카테고리: ${item.category || "-"}</div>
          <div>보관 장소: ${item.storageLocation || "-"}</div>
          <div>습득 장소: ${item.foundPlace || "-"}</div>
          <div>습득 시간: ${formatDateTime(
            item.foundTime || item.createdAt
          )}</div>
          <div>습득자: ${item.finderName || "-"}</div>
        `;

        const footer = document.createElement("div");
        footer.className = "item-footer";
        const dateSpan = document.createElement("span");
        dateSpan.textContent =
          "등록일: " + formatDateTime(item.createdAt);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const ownerBtn = document.createElement("button");
        ownerBtn.className = "btn btn-secondary";
        ownerBtn.textContent = "주인 찾음 처리";
        ownerBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (!confirm("주인을 찾은 분실물로 표시하시겠습니까?")) return;
          const ownerInfo = prompt(
            "주인 관련 메모를 남길 수 있습니다. (예: 4-1 홍길동, 9/1 수령)"
          );
          db.collection("lost_items")
            .doc(item.id)
            .update({
              status: "found",
              ownerInfo: ownerInfo || item.ownerInfo || ""
            })
            .catch((err) => {
              console.error(err);
              alert("상태 변경 중 오류가 발생했습니다.");
            });
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-danger";
        deleteBtn.textContent = "완전 삭제";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (
            !confirm(
              "정말 이 분실물을 Firestore에서 완전히 삭제하시겠습니까? (되돌릴 수 없음)"
            )
          )
            return;
          db.collection("lost_items")
            .doc(item.id)
            .delete()
            .catch((err) => {
              console.error(err);
              alert("삭제 중 오류가 발생했습니다.");
            });
        });

        actions.appendChild(ownerBtn);
        actions.appendChild(deleteBtn);

        footer.appendChild(dateSpan);
        footer.appendChild(actions);

        body.appendChild(titleRow);
        body.appendChild(meta);
        body.appendChild(footer);

        card.appendChild(thumb);
        card.appendChild(body);

        card.addEventListener("click", () => openDetailModal(item.id));

        itemsContainer.appendChild(card);
      });
    }

    // ===== 이미지 리사이즈 & 업로드 =====
    function resizeImage(file, maxSize) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width;
            let h = img.height;
            if (w >= h && w > maxSize) {
              h = Math.round((h * maxSize) / w);
              w = maxSize;
            } else if (h >= w && h > maxSize) {
              w = Math.round((w * maxSize) / h);
              h = maxSize;
            }
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob(
              (blob) => {
                if (!blob) {
                  reject(new Error("이미지 변환 실패"));
                  return;
                }
                resolve(blob);
              },
              "image/jpeg",
              0.8
            );
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function uploadToImgbb(blob) {
      const formData = new FormData();
      formData.append("image", blob);
      const url =
        "https://api.imgbb.com/1/upload?key=" +
        encodeURIComponent(IMGBB_API_KEY);
      const res = await fetch(url, {
        method: "POST",
        body: formData
      });
      if (!res.ok) {
        throw new Error(
          "imgbb 업로드 실패 (status " + res.status + ")"
        );
      }
      const data = await res.json();
      if (!data || !data.data || !data.data.url) {
        console.error("imgbb 응답:", data);
        throw new Error("imgbb 응답에 URL이 없습니다.");
      }
      return data.data.url;
    }

    // ===== 등록 폼 제출 =====
    lostItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!isTeacher) {
        alert(
          "@nsworld.net 교사 계정으로 로그인한 경우에만 등록할 수 있습니다."
        );
        return;
      }

      const file = itemImageInput.files[0];
      if (!file) {
        alert("분실물 사진을 업로드해 주세요.");
        return;
      }
      if (!itemTitleInput.value.trim()) {
        alert("분실물 이름 / 설명을 입력해 주세요.");
        itemTitleInput.focus();
        return;
      }
      if (!foundPlaceInput.value.trim()) {
        alert("습득 장소를 입력해 주세요.");
        foundPlaceInput.focus();
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "업로드 중...";

      try {
        const resizedBlob = await resizeImage(file, 800);
        const imageUrl = await uploadToImgbb(resizedBlob);

        const nowIso = new Date().toISOString();
        const foundTimeIso = foundTimeInput.value
          ? new Date(foundTimeInput.value).toISOString()
          : "";

        await db.collection("lost_items").add({
          title: itemTitleInput.value.trim(),
          category: itemCategorySelect.value,
          storageLocation: storageLocationSelect.value,
          foundPlace: foundPlaceInput.value.trim(),
          foundTime: foundTimeIso,
          finderName: finderNameInput.value.trim(),
          createdAt: nowIso,
          imageUrl: imageUrl,
          status: "stored",
          ownerInfo: ""
        });

        lostItemForm.reset();
        alert("분실물이 등록되었습니다.");
      } catch (err) {
        console.error(err);
        alert(
          "등록 중 오류가 발생했습니다. (이미지 서버 또는 Firestore)"
        );
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "등록";
      }
    });

    // ===== 모달 로직 =====
    function setModalEditable(editable) {
      [
        modalTitleInput,
        modalCategoryInput,
        modalStorageInput,
        modalFoundPlaceInput,
        modalFoundTimeInput,
        modalFinderInput,
        modalOwnerInfoInput
      ].forEach((el) => {
        el.disabled = !editable;
      });
      modalEditBtn.textContent = editable ? "저장" : "수정하기";
      modalEditMode = editable;
    }

    function openDetailModal(itemId) {
      const item = items.find((it) => it.id === itemId);
      if (!item) return;
      currentModalItemId = item.id;
      modalTitleText.textContent =
        item.title || "분실물 상세 정보";
      modalImage.src = item.imageUrl || "";
      modalImage.alt = item.title || "분실물 이미지";

      modalStatusLabel.innerHTML = "";
      const span = document.createElement("span");
      span.className =
        "status-label " + statusClass(item);
      span.textContent = statusLabel(item);
      modalStatusLabel.appendChild(span);

      modalTitleInput.value = item.title || "";
      modalCategoryInput.value = item.category || "";
      modalStorageInput.value = item.storageLocation || "";
      modalFoundPlaceInput.value = item.foundPlace || "";
      modalFoundTimeInput.value = formatDateTime(
        item.foundTime || item.createdAt
      );
      modalFinderInput.value = item.finderName || "";
      modalCreatedAtInput.value = formatDateTime(item.createdAt);
      modalOwnerInfoInput.value = item.ownerInfo || "";

      setModalEditable(false);
      detailModalBackdrop.style.display = "flex";
    }

    function closeDetailModal() {
      detailModalBackdrop.style.display = "none";
      currentModalItemId = null;
      setModalEditable(false);
    }

    modalCloseBtn.addEventListener("click", closeDetailModal);
    detailModalBackdrop.addEventListener("click", (e) => {
      if (e.target === detailModalBackdrop) {
        closeDetailModal();
      }
    });

    modalEditBtn.addEventListener("click", async () => {
      if (!currentModalItemId) return;
      if (!modalEditMode) {
        setModalEditable(true);
        return;
      }
      // 저장
      try {
        await db.collection("lost_items")
          .doc(currentModalItemId)
          .update({
            title: modalTitleInput.value.trim(),
            category: modalCategoryInput.value.trim() || "기타",
            storageLocation: modalStorageInput.value.trim(),
            foundPlace: modalFoundPlaceInput.value.trim(),
            finderName: modalFinderInput.value.trim(),
            ownerInfo: modalOwnerInfoInput.value.trim()
          });
        alert("수정이 저장되었습니다.");
        closeDetailModal(); // onSnapshot 으로 목록 자동 갱신
      } catch (err) {
        console.error(err);
        alert("수정 저장 중 오류가 발생했습니다.");
      }
    });

    modalReRegisterBtn.addEventListener("click", async () => {
      if (!currentModalItemId) return;
      if (
        !confirm(
          "이 분실물을 다시 '보관 중' 상태로 재등록하시겠습니까?\n(등록일은 지금 시각으로 갱신됩니다.)"
        )
      )
        return;
      try {
        await db.collection("lost_items")
          .doc(currentModalItemId)
          .update({
            status: "stored",
            createdAt: new Date().toISOString()
          });
        alert("재등록 되었습니다.");
        closeDetailModal();
      } catch (err) {
        console.error(err);
        alert("재등록 중 오류가 발생했습니다.");
      }
    });

    // ===== 인증 =====
    loginBtn.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });
      auth.signInWithPopup(provider).catch((err) => {
        console.error(err);
        alert("로그인 중 오류가 발생했습니다.");
      });
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut().catch((err) => {
        console.error(err);
        alert("로그아웃 중 오류가 발생했습니다.");
      });
    });

    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateAuthUI();
      if (!user) {
        // 로그인 안 해도 목록은 보이도록
        if (!unsubscribeItems) subscribeItems();
      }
    });

    // 첫 로드 시 목록 구독
    subscribeItems();
  </script>
</body>
</html>
